<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<script src="coi-serviceworker.js"></script>
		<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
		<title>AR_Scratch_System</title>
		<style>
			/* 基礎樣式重置 */
			html, body {
				margin: 0;
				padding: 0;
				border: 0;
				width: 100%;
				height: 100%;
				overflow: hidden;
				background-color: transparent; /* 關鍵：本體透明 */
			}

			/* 相機畫面置底 */
			video#webcam {
				position: fixed;
				top: 0;
				left: 0;
				width: 100vw;
				height: 100vh;
				object-fit: cover;
				z-index: -1; /* 在最下面 */
				pointer-events: none;
				background: black; /* 載入前預設黑色 */
			}

			/* Godot 畫布 */
			#canvas {
				display: block;
				width: 100vw;
				height: 100vh;
				background-color: transparent !important; /* 強制透明 */
				z-index: 1; /* 在相機上面 */
			}

			#canvas:focus {
				outline: none;
			}

			/* 讀取進度條樣式 */
			#status {
				position: absolute;
				top: 0; left: 0; right: 0; bottom: 0;
				background-color: rgba(36, 36, 36, 0.9);
				display: flex;
				flex-direction: column;
				justify-content: center;
				align-items: center;
				z-index: 10;
			}

			#status-progress {
				width: 50%;
				height: 20px;
			}

			#status-notice {
				color: white;
				margin-top: 20px;
				padding: 10px;
				background: rgba(155, 57, 67, 0.8);
				border-radius: 5px;
				display: none;
			}
		</style>
	</head>
	<body>
		<!-- 1. 放置相機標籤 -->
		<video id="webcam" autoplay playsinline muted></video>

		<!-- 2. Godot 畫布 -->
		<canvas id="canvas">您的瀏覽器不支持 Canvas。</canvas>

		<div id="status">
			<progress id="status-progress"></progress>
			<div id="status-notice"></div>
			<p style="color:white;">AR 載入中，請稍候...</p>
		</div>

		<script src="index.js"></script>
		<script>
			// 啟動相機函數
			async function startCamera() {
				const video = document.getElementById('webcam');
				try {
					const stream = await navigator.mediaDevices.getUserMedia({ 
						video: { 
							facingMode: "environment", // 使用後鏡頭
							width: { ideal: 1280 },
							height: { ideal: 720 }
						} 
					});
					video.srcObject = stream;
					console.log("相機已啟動");
				} catch (err) {
					console.error("無法存取相機: ", err);
					// 如果失敗，可能是沒給權限
					alert("請允許相機權限以啟用 AR 功能。");
				}
			}

			// 啟動 Godot 引擎
			const GODOT_CONFIG = {
				"args": [],
				"canvasResizePolicy": 2,
				"executable": "index",
				"fileSizes": {"index.pck": 500032, "index.wasm": 36145869},
				"focusCanvas": true
			};
			
			const engine = new Engine(GODOT_CONFIG);

			(function() {
				const statusOverlay = document.getElementById('status');
				const statusProgress = document.getElementById('status-progress');
				const statusNotice = document.getElementById('status-notice');

				// 1. 先嘗試啟動相機
				startCamera();

				// 2. 啟動 Godot
				engine.startGame({
					'onProgress': function (current, total) {
						if (total > 0) {
							statusProgress.value = current;
							statusProgress.max = total;
						}
					},
				}).then(() => {
					statusOverlay.style.display = 'none';
					// 進入遊戲後再次確保相機在動
					document.getElementById('webcam').play();
				}).catch((err) => {
					statusNotice.innerText = err.message;
					statusNotice.style.display = 'block';
				});
			})();
		</script>
	</body>
</html>
